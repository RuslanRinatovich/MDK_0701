# üîô üìö üîú –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫—É—Ä—Å—É

| [–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ](../LESSONS/PR16.MD) | &nbsp; | [–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ](../LESSONS/PR17.MD) |
|:--------------------------------------:|:------:|:-------------------------------------:|
| üè† [–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Ññ16](../LESSONS/PR16.MD) | üìñ [–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ](../README.MD) | üíª [–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Ññ17](../LESSONS/PR17.MD) |

# üéì –õ–µ–∫—Ü–∏—è 17. –ñ—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–º –∏ —É—Å–µ—á–µ–Ω–∏–µ

‚è±Ô∏è **–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 90 –º–∏–Ω—É—Ç  
üéØ **–¶–µ–ª—å –ª–µ–∫—Ü–∏–∏:**  
–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —É —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≥–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∂—É—Ä–Ω–∞–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ –µ–≥–æ —Ä–æ—Å—Ç–∞ –∏ —É—Å–µ—á–µ–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ –º–µ—Ç–æ–¥–æ–≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –Ω–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–º —Ä–æ—Å—Ç–æ–º. –ù–∞—É—á–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞–∑–º–µ—Ä–æ–º –∂—É—Ä–Ω–∞–ª–∞, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å –æ—à–∏–±–∫–∏ 9002 –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –±–µ—Å–ø–µ—Ä–µ–±–æ–π–Ω—É—é —Ä–∞–±–æ—Ç—É –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö.

---
## üìñ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ç–µ—Ä–º–∏–Ω–æ–≤ (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–∑ —Ä—É—Å—Å–∫–æ–π SSMS)

| –†—É—Å—Å–∫–∏–π —Ç–µ—Ä–º–∏–Ω | –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç | –ß—Ç–æ —ç—Ç–æ? | –ü—Ä–∏–º–µ—Ä |
|----------------|------------------------|----------|--------|
| –ñ—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | Transaction log | –§–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ–∞–π–ª `.ldf`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∑–∞–ø–∏—Å–∏ –æ–±–æ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö | `AdventureWorks_log.ldf` |
| –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞ | Virtual Log File (VLF) | –°–µ–∫—Ç–æ—Ä –≤–Ω—É—Ç—Ä–∏ —Ñ–∞–π–ª–∞ –∂—É—Ä–Ω–∞–ª–∞, –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ñ—É—Ä–Ω–∞–ª —Ä–∞–∑–±–∏—Ç –Ω–∞ VLF |
| –ê–∫—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç—å –∂—É—Ä–Ω–∞–ª–∞ | Active log | –ß–∞—Å—Ç—å –∂—É—Ä–Ω–∞–ª–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ | –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å–µ—á–µ–Ω–∞ |
| –ù–µ–∞–∫—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç—å –∂—É—Ä–Ω–∞–ª–∞ | Inactive log | –ß–∞—Å—Ç—å –∂—É—Ä–Ω–∞–ª–∞ —Å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏, –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è | –£—Å–µ–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ CHECKPOINT –∏–ª–∏ BACKUP LOG |
| –£—Å–µ—á–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ | Log truncation | –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –≤ –∂—É—Ä–Ω–∞–ª–µ (–ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ —Å–≤–æ–±–æ–¥–Ω–æ–µ) | –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ SIMPLE, –ø–æ –∫–æ–º–∞–Ω–¥–µ –≤ FULL |
| –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ | CHECKPOINT | –ó–∞–ø–∏—Å—å –≥—Ä—è–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –Ω–∞ –¥–∏—Å–∫, –≤ SIMPLE –∑–∞–ø—É—Å–∫–∞–µ—Ç —É—Å–µ—á–µ–Ω–∏–µ | `CHECKPOINT;` |
| –ù–æ–º–µ—Ä –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ –∂—É—Ä–Ω–∞–ª–µ | Log Sequence Number (LSN) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª–µ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è |
| –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ | Log reuse | –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π —á–∞—Å—Ç–∏ –∂—É—Ä–Ω–∞–ª–∞ –Ω–æ–≤—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ | –ñ—É—Ä–Ω–∞–ª —Ä–∞–±–æ—Ç–∞–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏ |
| –ê–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ | Autogrowth | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∂—É—Ä–Ω–∞–ª–∞ –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –º–µ—Å—Ç–∞ | `ALTER DATABASE ... MODIFY FILE` |
| –û—à–∏–±–∫–∞ 9002 | Error 9002 | "The transaction log for database is full" | –ñ—É—Ä–Ω–∞–ª –∑–∞–ø–æ–ª–Ω–µ–Ω, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ |
| DBCC SHRINKFILE | DBCC SHRINKFILE | –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∂—É—Ä–Ω–∞–ª–∞ | `DBCC SHRINKFILE (N'log_file_name', target_size)` |

---

## 1. üß± –ê–Ω–∞—Ç–æ–º–∏—è –∂—É—Ä–Ω–∞–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### 1.1. –§–∏–∑–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

–ñ—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ñ–∞–π–ª, –∞ **–∫–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä**. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Å–µ–±–µ –ø–ª—ë–Ω–∫—É –¥–ª—è –≤–∏–¥–µ–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞—Ü–∏–∫–ª–µ–Ω–∞:

```mermaid
graph LR
    subgraph "–§–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞ (.ldf)"
        A[VLF 1] --> B[VLF 2] --> C[VLF 3] --> D[VLF 4] --> E[VLF 5] --> A
    end
```

–ö–æ–≥–¥–∞ –º–µ—Å—Ç–æ –≤ –∫–æ–Ω—Ü–µ —Ñ–∞–π–ª–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è, –∑–∞–ø–∏—Å—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —Å –Ω–∞—á–∞–ª–∞, **–µ—Å–ª–∏** –ø–µ—Ä–≤—ã–µ VLF —É–∂–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã –∏ –ø–æ–º–µ—á–µ–Ω—ã –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

### 1.2. –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∂—É—Ä–Ω–∞–ª–∞ (VLF)

SQL Server —Ä–∞–∑–±–∏–≤–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞ –Ω–∞ **–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∂—É—Ä–Ω–∞–ª–∞ (VLF)**. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –¥–ª—è –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

**–ö–∞–∫ —Å–æ–∑–¥–∞—é—Ç—Å—è VLF:**
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –∂—É—Ä–Ω–∞–ª–∞ (–∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–ª–∏ —Ä—É—á–Ω–æ–µ)

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ VLF –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∏ —à–∞–≥–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:**

| –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ VLF |
|--------------|----------------|
| –î–æ 64 –ú–ë | 4 |
| 64 –ú–ë ‚Äì 1 –ì–ë | 8 |
| –ë–æ–ª—å—à–µ 1 –ì–ë | 16 |
| –ü—Ä–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ | 4 –Ω–æ–≤—ã—Ö VLF |

‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞:** –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ–µ –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–∞–ª–µ–Ω—å–∫–∏–º–∏ —à–∞–≥–∞–º–∏ —Å–æ–∑–¥–∞—ë—Ç —Ç—ã—Å—è—á–∏ –º–µ–ª–∫–∏—Ö VLF, —á—Ç–æ –∑–∞–º–µ–¥–ª—è–µ—Ç:
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã
- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞
- –û–ø–µ—Ä–∞—Ü–∏–∏ —É—Å–µ—á–µ–Ω–∏—è

### 1.3. –ê–∫—Ç–∏–≤–Ω–∞—è –∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç–∏

```mermaid
graph TD
    subgraph "–ñ—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"
        A["VLF 1\n(–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω)"] --> B["VLF 2\n(–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω)"]
        B --> C["VLF 3\n(–∞–∫—Ç–∏–≤–µ–Ω)"]
        C --> D["VLF 4\n(–∞–∫—Ç–∏–≤–µ–Ω)"]
        D --> E["VLF 5\n(–∞–∫—Ç–∏–≤–µ–Ω)"]
    end
    F["–ü–æ—Å–ª–µ–¥–Ω—è—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞"] -.-> C
    G["–°–∞–º–∞—è —Å—Ç–∞—Ä–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è"] -.-> C
```

- **–ê–∫—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç—å** ‚Äî VLF, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –û–Ω–∏ **–Ω–∏–∫–æ–≥–¥–∞** –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã.
- **–ù–µ–∞–∫—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç—å** ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã, –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –¥–∏—Å–∫. –≠—Ç–∏ VLF –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ —Å–≤–æ–±–æ–¥–Ω—ã–µ.

---

## 2. üîÑ –ú–µ—Ö–∞–Ω–∏–∑–º —É—Å–µ—á–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞

### 2.1. –ß—Ç–æ —Ç–∞–∫–æ–µ —É—Å–µ—á–µ–Ω–∏–µ?

–£—Å–µ—á–µ–Ω–∏–µ (truncation) ‚Äî —ç—Ç–æ **–ª–æ–≥–∏—á–µ—Å–∫–æ–µ** –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –≤ –∂—É—Ä–Ω–∞–ª–µ. –§–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ–∞–π–ª `.ldf` **–Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è**! –ü—Ä–æ—Å—Ç–æ VLF –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

```mermaid
graph LR
    subgraph "–î–æ —É—Å–µ—á–µ–Ω–∏—è"
        A[VLF 1<br/>–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è] --> B[VLF 2<br/>–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è]
        B --> C[VLF 3<br/>–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è]
        C --> D[VLF 4<br/>–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è]
    end
    
    subgraph "–ü–æ—Å–ª–µ —É—Å–µ—á–µ–Ω–∏—è"
        E[VLF 1<br/>–°–í–û–ë–û–î–ù–û] --> F[VLF 2<br/>–°–í–û–ë–û–î–ù–û]
        F --> G[VLF 3<br/>–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è]
        G --> H[VLF 4<br/>–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è]
    end
```

### 2.2. –ö–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —É—Å–µ—á–µ–Ω–∏–µ?

**–í –º–æ–¥–µ–ª–∏ SIMPLE:**
- –ü—Ä–∏ –∫–∞–∂–¥–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Ç–æ—á–∫–µ (`CHECKPOINT`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –±–µ–∑ —É—á–∞—Å—Ç–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

**–í –º–æ–¥–µ–ª–∏ FULL:**
- **–¢–æ–ª—å–∫–æ** –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `BACKUP LOG`
- –ù–∏–∫–∞–∫–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –Ω–µ —É—Å–µ–∫–∞—é—Ç –∂—É—Ä–Ω–∞–ª!

**–í –º–æ–¥–µ–ª–∏ BULK_LOGGED:**
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ FULL, —É—Å–µ—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ `BACKUP LOG`

### 2.3. –ß—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É—Å–µ—á–µ–Ω–∏–µ?

1. **–ê–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** ‚Äî —Å–∞–º–∞—è —á–∞—Å—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞. –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–±—ã—Ç—ã–π `BEGIN TRAN`), –∂—É—Ä–Ω–∞–ª –Ω–µ —É—Å–µ–∫–∞–µ—Ç—Å—è.
2. **–†–µ–ø–ª–∏–∫–∞—Ü–∏—è** ‚Äî –µ—Å–ª–∏ –±–∞–∑–∞ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏, –∂—É—Ä–Ω–∞–ª –Ω—É–∂–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.
3. **–û–ø–µ—Ä–∞—Ü–∏–∏ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º** ‚Äî –≤ BULK_LOGGED –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç —É—Å–µ—á–µ–Ω–∏–µ.
4. **Always On Availability Groups** ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Ä–µ–ø–ª–∏–∫–∞–º–∏.
5. **–ó–∞–¥–∞—á–∞ —á—Ç–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞** ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, CDC (Change Data Capture) –∏–ª–∏ –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è.

---

## 3. üìà –ü–æ—á–µ–º—É –∂—É—Ä–Ω–∞–ª —Ä–∞—Å—Ç—ë—Ç?

### 3.1. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

| –ü—Ä–∏—á–∏–Ω–∞ | –û–±—ä—è—Å–Ω–µ–Ω–∏–µ | –†–µ—à–µ–Ω–∏–µ |
|---------|------------|---------|
| **–ù–µ—Ç –±—ç–∫–∞–ø–æ–≤ –∂—É—Ä–Ω–∞–ª–∞ –≤ FULL** | –ñ—É—Ä–Ω–∞–ª –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É—Å–µ–∫–∞–µ—Ç—Å—è | –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ `BACKUP LOG` |
| **–î–ª–∏–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** | –ê–∫—Ç–∏–≤–Ω–∞—è —á–∞—Å—Ç—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å–µ—á–µ–Ω–∞ | –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ–º–º–∏—Ç–∏—Ç—å —á–∞—â–µ |
| **–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ–µ –º–∞–ª–æ–µ –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ** | –°–æ–∑–¥–∞—é—Ç—Å—è —Ç—ã—Å—è—á–∏ VLF, —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è | –£–≤–µ–ª–∏—á–∏—Ç—å —à–∞–≥ –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –∂—É—Ä–Ω–∞–ª |
| **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∏–ª–∏ –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** | –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –º–Ω–æ–≥–æ –∑–∞–ø–∏—Å–µ–π –≤ –∂—É—Ä–Ω–∞–ª–µ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å BULK_LOGGED –≤—Ä–µ–º–µ–Ω–Ω–æ |
| **–†–µ–ø–ª–∏–∫–∞—Ü–∏—è / CDC** | –ñ—É—Ä–Ω–∞–ª –Ω—É–∂–µ–Ω –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º | –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω—É—é –æ—á–∏—Å—Ç–∫—É |

### 3.2. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ä–æ—Å—Ç–∞

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
DBCC SQLPERF(LOGSPACE);

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
-- Database Name, Log Size (MB), Log Space Used (%), Status
```

```sql
-- –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ VLF
DBCC LOGINFO('–ò–º—è_–ë–î');
```
–ü–æ–ª–µ `Status`:
- 0 ‚Äî VLF —Å–≤–æ–±–æ–¥–µ–Ω (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- 2 ‚Äî VLF –∞–∫—Ç–∏–≤–µ–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

### 3.3. –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ä–æ—Å—Ç–∞

–ï—Å–ª–∏ –∂—É—Ä–Ω–∞–ª —Ä–∞—Å—Ç—ë—Ç –Ω–∞ 1 –ì–ë –≤ —á–∞—Å, –∞ –±—ç–∫–∞–ø—ã –ª–æ–≥–∞ –¥–µ–ª–∞—é—Ç—Å—è —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏, —Ç–æ —á–µ—Ä–µ–∑ —Å—É—Ç–∫–∏ —Ä–∞–∑–º–µ—Ä –∂—É—Ä–Ω–∞–ª–∞ –±—É–¥–µ—Ç 24 –ì–ë. –ï—Å–ª–∏ –¥–∏—Å–∫ –≤—Å–µ–≥–æ 50 –ì–ë, —á–µ—Ä–µ–∑ –¥–≤–æ–µ —Å—É—Ç–æ–∫ –±–∞–∑–∞ —É–ø–∞–¥—ë—Ç —Å –æ—à–∏–±–∫–æ–π 9002.

**–§–æ—Ä–º—É–ª–∞:**
```
–í—Ä–µ–º—è_–¥–æ_–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è = (–°–≤–æ–±–æ–¥–Ω–æ–µ_–º–µ—Å—Ç–æ - –¢–µ–∫—É—â–∏–π_—Ä–∞–∑–º–µ—Ä_–∂—É—Ä–Ω–∞–ª–∞) / –°–∫–æ—Ä–æ—Å—Ç—å_—Ä–æ—Å—Ç–∞_–≤_—á–∞—Å
```

---

## 4. üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–º –∂—É—Ä–Ω–∞–ª–∞

### 4.1. –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –±—ç–∫–∞–ø—ã –∂—É—Ä–Ω–∞–ª–∞ (—Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ!)

```sql
-- –í FULL –º–æ–¥–µ–ª–∏ —ç—Ç–æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!
BACKUP LOG [–ò–º—è_–ë–î] 
TO DISK = N'D:\Backup\–ò–º—è_–ë–î_Log_' + FORMAT(GETDATE(), 'yyyyMMdd_HHmm') + '.trn'
WITH COMPRESSION, CHECKSUM;
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —á–∞—Å—Ç–æ—Ç–µ:**
- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã: –∫–∞–∂–¥—ã–µ 5-15 –º–∏–Ω—É—Ç
- –û–±—ã—á–Ω—ã–µ OLTP: –∫–∞–∂–¥—ã–µ 30-60 –º–∏–Ω—É—Ç
- –•—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö: –∫–∞–∂–¥—ã–µ 2-4 —á–∞—Å–∞

### 4.2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ —Å –∂—É—Ä–Ω–∞–ª–æ–º
DECLARE @logDrive CHAR(1);
SELECT @logDrive = LEFT(physical_name, 1)
FROM sys.database_files
WHERE type_desc = 'LOG';

EXEC xp_fixeddrives; -- –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –≤—Å–µ—Ö –¥–∏—Å–∫–∞—Ö
```

### 4.3. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–µ—á–µ–Ω–∏–µ (–µ—Å–ª–∏ –±—ç–∫–∞–ø –ª–æ–≥–∞ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω)

–ò–Ω–æ–≥–¥–∞ –∂—É—Ä–Ω–∞–ª –≤—ã—Ä–æ—Å —Ç–∞–∫, —á—Ç–æ –¥–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω, –∏ `BACKUP LOG` –Ω–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª. –¢–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –≤ SIMPLE:

```sql
-- –í–ê–ñ–ù–û: –í—ã —Ç–µ—Ä—è–µ—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å PITR —Å —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞!
ALTER DATABASE –ò–º—è_–ë–î SET RECOVERY SIMPLE;
CHECKPOINT; -- –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–µ—á–µ–Ω–∏–µ
ALTER DATABASE –ò–º—è_–ë–î SET RECOVERY FULL; -- –≤–µ—Ä–Ω—É—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
-- –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø!
```

### 4.4. –§–∏–∑–∏—á–µ—Å–∫–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ (SHRINKFILE)

`SHRINKFILE` ‚Äî **–∫—Ä–∞–π–Ω—è—è –º–µ—Ä–∞**, —Ç–∞–∫ –∫–∞–∫:
- –í—ã–∑—ã–≤–∞–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—é VLF
- –ó–∞–º–µ–¥–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
- –í—Ä–µ–º–µ–Ω–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏

```sql
-- –°–Ω–∞—á–∞–ª–∞ —É—Å–µ–∫–∞–µ–º –∂—É—Ä–Ω–∞–ª (–±—ç–∫–∞–ø –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ SIMPLE)
-- –ó–∞—Ç–µ–º —É–º–µ–Ω—å—à–∞–µ–º —Ñ–∞–π–ª
DBCC SHRINKFILE (N'–ò–º—è_–ª–æ–≥_—Ñ–∞–π–ª–∞', target_size_MB);
```

**–ü—Ä–∏–º–µ—Ä:**
```sql
-- –£–∑–Ω–∞—Ç—å –ª–æ–≥–∏—á–µ—Å–∫–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –∂—É—Ä–Ω–∞–ª–∞
SELECT name FROM sys.database_files WHERE type_desc = 'LOG';

-- –£–º–µ–Ω—å—à–∏—Ç—å –¥–æ 1 –ì–ë (1024 –ú–ë)
DBCC SHRINKFILE (N'AdventureWorks_log', 1024);
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:**
1. –°–¥–µ–ª–∞—Ç—å `BACKUP LOG`
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å `SHRINKFILE` –¥–æ —Ä–∞–∑—É–º–Ω–æ–≥–æ –º–∏–Ω–∏–º—É–º–∞
3. –°—Ä–∞–∑—É –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–º —à–∞–≥–æ–º
4. –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º –±—ç–∫–∞–ø–∞–º –∂—É—Ä–Ω–∞–ª–∞

### 4.5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

```sql
-- –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
SELECT 
    name,
    type_desc,
    size * 8 / 1024 AS CurrentSizeMB,
    growth,
    is_percent_growth,
    max_size
FROM sys.database_files;

-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
ALTER DATABASE [–ò–º—è_–ë–î] 
MODIFY FILE 
(NAME = '–ò–º—è_–ª–æ–≥_—Ñ–∞–π–ª–∞', 
 FILEGROWTH = 512MB,      -- —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä
 MAXSIZE = 50GB);          -- –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —à–∞–≥** (512 –ú–ë –∏–ª–∏ 1 –ì–ë), –∞ –Ω–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
- –ü—Ä–æ—Ü–µ–Ω—Ç—ã –ø—Ä–∏ –º–∞–ª–µ–Ω—å–∫–æ–º —Ä–∞–∑–º–µ—Ä–µ –¥–∞—é—Ç –º–µ–ª–∫–∏–µ VLF
- –ü—Ä–æ—Ü–µ–Ω—Ç—ã –ø—Ä–∏ –±–æ–ª—å—à–æ–º —Ä–∞–∑–º–µ—Ä–µ –¥–∞—é—Ç –≥–∏–≥–∞–Ω—Ç—Å–∫–∏–µ —Å–∫–∞—á–∫–∏

---

## 5. üß™ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å –∂—É—Ä–Ω–∞–ª–æ–º

### 5.1. –ü–æ–∏—Å–∫ –¥–ª–∏–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

```sql
-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
SELECT 
    transaction_id,
    database_id,
    transaction_begin_time,
    transaction_type,
    transaction_state
FROM sys.dm_tran_active_transactions;

-- –°–µ—Å—Å–∏–∏ —Å –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
SELECT 
    session_id,
    transaction_id,
    open_transaction_count
FROM sys.dm_tran_session_transactions
WHERE open_transaction_count > 0;

-- –ó–∞–ø—Ä–æ—Å—ã, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–µ—Å—è –¥–æ–ª—å—à–µ 30 –º–∏–Ω—É—Ç
SELECT 
    r.session_id,
    r.start_time,
    DATEDIFF(minute, r.start_time, GETDATE()) AS minutes_running,
    t.text
FROM sys.dm_exec_requests r
CROSS APPLY sys.dm_exec_sql_text(r.sql_handle) t
WHERE r.start_time < DATEADD(minute, -30, GETDATE());
```

### 5.2. –ü–æ—á–µ–º—É –∂—É—Ä–Ω–∞–ª –Ω–µ —É—Å–µ–∫–∞–µ—Ç—Å—è?

```sql
-- –ü—Ä–∏—á–∏–Ω—ã, –ø—Ä–µ–ø—è—Ç—Å—Ç–≤—É—é—â–∏–µ —É—Å–µ—á–µ–Ω–∏—é
SELECT 
    name,
    log_reuse_wait_desc
FROM sys.databases
WHERE name = DB_NAME();
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è `log_reuse_wait_desc`:**
- `NOTHING` ‚Äî –≤—Å—ë —Ö–æ—Ä–æ—à–æ, –º–æ–∂–Ω–æ —É—Å–µ–∫–∞—Ç—å
- `LOG_BACKUP` ‚Äî –∂–¥—ë—Ç –±—ç–∫–∞–ø–∞ –∂—É—Ä–Ω–∞–ª–∞ (–≤ FULL)
- `ACTIVE_TRANSACTION` ‚Äî –∞–∫—Ç–∏–≤–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
- `REPLICATION` ‚Äî –∂–¥—ë—Ç —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é
- `AVAILABILITY_REPLICA` ‚Äî –∂–¥—ë—Ç Always On
- `CHECKPOINT` ‚Äî –∂–¥—ë—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Ç–æ—á–∫—É
- `ACTIVE_BACKUP_OR_RESTORE` ‚Äî –∏–¥—ë—Ç –±—ç–∫–∞–ø/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

### 5.3. –ê–Ω–∞–ª–∏–∑ VLF

```sql
-- –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
CREATE TABLE #VLFInfo (
    FileID INT,
    FileSize BIGINT,
    StartOffset BIGINT,
    FSeqNo BIGINT,
    Status INT,
    Parity INT,
    CreateLSN NUMERIC(38)
);

INSERT INTO #VLFInfo
EXEC ('DBCC LOGINFO');

SELECT 
    COUNT(*) AS TotalVLF,
    SUM(CASE WHEN Status = 2 THEN 1 ELSE 0 END) AS ActiveVLF,
    SUM(CASE WHEN Status = 0 THEN 1 ELSE 0 END) AS FreeVLF
FROM #VLFInfo;

DROP TABLE #VLFInfo;
```

**–ù–æ—Ä–º–∞:** –º–µ–Ω–µ–µ 50-100 VLF. –ï—Å–ª–∏ —Ç—ã—Å—è—á–∏ ‚Äî –ø—Ä–æ–±–ª–µ–º–∞.

---

## 6. üö® –ê–≤–∞—Ä–∏–π–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ

### 6.1. –û—à–∏–±–∫–∞ 9002: "The transaction log for database is full"

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ë–∞–∑–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
- –í –ª–æ–≥–µ –æ—à–∏–±–æ–∫ SQL Server —Å–æ–æ–±—â–µ–Ω–∏–µ 9002
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –º–æ–≥—É—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å/–æ–±–Ω–æ–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ

**–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:**

```mermaid
graph TD
    A[–û—à–∏–±–∫–∞ 9002] --> B{–ï—Å—Ç—å –ª–∏ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ?}
    B -->|–î–∞| C[–°–¥–µ–ª–∞—Ç—å BACKUP LOG]
    B -->|–ù–µ—Ç| D{–ú–æ–∂–Ω–æ –ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–∏—Å–∫?}
    D -->|–î–∞| E[–†–∞—Å—à–∏—Ä–∏—Ç—å –¥–∏—Å–∫]
    D -->|–ù–µ—Ç| F[–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤ SIMPLE]
    
    C --> G[–ü—Ä–æ–≤–µ—Ä–∏—Ç—å log_reuse_wait_desc]
    G --> H[–£—Å—Ç—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É]
    
    F --> I[SHRINKFILE –¥–æ —Ä–∞–∑—É–º–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞]
    I --> J[–í–µ—Ä–Ω—É—Ç—å FULL –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –±—ç–∫–∞–ø—ã]
```

**–ü–æ–¥—Ä–æ–±–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤–∞—Ä–∏–π–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:**

```sql
-- –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏—á–∏–Ω—É
SELECT name, log_reuse_wait_desc FROM sys.databases WHERE name = 'ProblemDB';

-- –®–∞–≥ 2: –ï—Å–ª–∏ –ø—Ä–∏—á–∏–Ω–∞ LOG_BACKUP, –¥–µ–ª–∞–µ–º –±—ç–∫–∞–ø
BACKUP LOG ProblemDB TO DISK = 'D:\Backup\ProblemDB_emergency.trn';

-- –®–∞–≥ 3: –ï—Å–ª–∏ –ø—Ä–∏—á–∏–Ω–∞ ACTIVE_TRANSACTION, –Ω–∞—Ö–æ–¥–∏–º –∏ —É–±–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é
SELECT session_id FROM sys.dm_tran_session_transactions WHERE database_id = DB_ID('ProblemDB');
KILL <session_id>;

-- –®–∞–≥ 4: –ï—Å–ª–∏ –¥–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω –∏ –±—ç–∫–∞–ø –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω
ALTER DATABASE ProblemDB SET RECOVERY SIMPLE;
CHECKPOINT;
DBCC SHRINKFILE (N'ProblemDB_log', 1000); -- —É–º–µ–Ω—å—à–∏—Ç—å –¥–æ 1 –ì–ë
ALTER DATABASE ProblemDB SET RECOVERY FULL;
BACKUP DATABASE ProblemDB TO DISK = 'D:\Backup\ProblemDB_full_after_crash.bak';
```

### 6.2. –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ VLF

**–†–µ—à–µ–Ω–∏–µ:**
1. –°–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø
2. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤ SIMPLE (–µ—Å–ª–∏ –º–æ–∂–Ω–æ)
3. –í—ã–ø–æ–ª–Ω–∏—Ç—å `SHRINKFILE` –¥–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
4. –£–≤–µ–ª–∏—á–∏—Ç—å —Ñ–∞–π–ª —Å—Ä–∞–∑—É –¥–æ –Ω—É–∂–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ **–æ–¥–Ω–∏–º —à–∞–≥–æ–º** (CREATE)
5. –í–µ—Ä–Ω—É—Ç—å –º–æ–¥–µ–ª—å FULL
6. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å –±–æ–ª—å—à–∏–º —à–∞–≥–æ–º

```sql
-- –°–±—Ä–æ—Å VLF (—Ç—Ä–µ–±—É–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–∞–∑—ã)
ALTER DATABASE ProblemDB SET OFFLINE;
-- –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞ (!!!) –∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞–Ω–æ–≤–æ - —Å–ª–æ–∂–Ω–æ, –ª—É—á—à–µ –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–±

-- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±:
-- 1. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤ SIMPLE
ALTER DATABASE ProblemDB SET RECOVERY SIMPLE;
-- 2. –°–∂–∞—Ç—å –¥–æ –º–∏–Ω–∏–º—É–º–∞
DBCC SHRINKFILE (N'ProblemDB_log', 1);
-- 3. –†–∞—Å—à–∏—Ä–∏—Ç—å —Å—Ä–∞–∑—É –¥–æ –Ω—É–∂–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
ALTER DATABASE ProblemDB 
MODIFY FILE (NAME = 'ProblemDB_log', SIZE = 10GB);
-- 4. –í–µ—Ä–Ω—É—Ç—å FULL
ALTER DATABASE ProblemDB SET RECOVERY FULL;
-- 5. –°–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø
```

---

## 7. üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### 7.1. –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∂—É—Ä–Ω–∞–ª–æ–≤

```sql
SELECT 
    d.name AS DatabaseName,
    mf.physical_name,
    mf.size * 8 / 1024 AS SizeMB,
    ls.log_space_used_percent AS UsedPercent,
    d.log_reuse_wait_desc AS ReuseWait,
    d.recovery_model_desc AS RecoveryModel
FROM sys.databases d
JOIN sys.master_files mf ON d.database_id = mf.database_id AND mf.type_desc = 'LOG'
CROSS APPLY (SELECT DBCC SQLPERF(LOGSPACE) ... ) -- —Å–ª–æ–∂–Ω–æ, –ø—Ä–æ—â–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä
ORDER BY ls.log_space_used_percent DESC;
```

–£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:
```sql
-- –°–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è DBCC SQLPERF
CREATE TABLE #LogSpace (
    DatabaseName NVARCHAR(128),
    LogSizeMB DECIMAL(18,5),
    LogSpaceUsedPercent DECIMAL(18,5),
    Status INT
);

INSERT INTO #LogSpace
EXEC ('DBCC SQLPERF(LOGSPACE)');

SELECT * FROM #LogSpace WHERE LogSpaceUsedPercent > 80;
DROP TABLE #LogSpace;
```

### 7.2. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ–ø–æ–≤–µ—â–µ–Ω–∏–π

**–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è SQL Agent –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ email, –µ—Å–ª–∏ –∂—É—Ä–Ω–∞–ª –∑–∞–ø–æ–ª–Ω–µ–Ω –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 80%
DECLARE @UsedPercent DECIMAL(18,5);

SELECT @UsedPercent = LogSpaceUsedPercent
FROM #LogSpace
WHERE DatabaseName = 'AdventureWorks';

IF @UsedPercent > 80
BEGIN
    EXEC msdb.dbo.sp_send_dbmail
        @profile_name = 'DBA Profile',
        @recipients = 'dba@company.com',
        @subject = 'WARNING: Transaction log usage high',
        @body = 'AdventureWorks log is ' + CAST(@UsedPercent AS VARCHAR) + '% full';
END
```

### 7.3. Best practices –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–æ–º

| –ü—Ä–∞–∫—Ç–∏–∫–∞ | –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ |
|----------|------------------|
| **–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –±—ç–∫–∞–ø—ã –ª–æ–≥–∞** | –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± —É—Å–µ—á–µ–Ω–∏—è –≤ FULL |
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ log_reuse_wait** | –£–≤–∏–¥–µ—Ç—å –ø—Ä–æ–±–ª–µ–º—É –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –¥–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è |
| **–ê–¥–µ–∫–≤–∞—Ç–Ω—ã–π —à–∞–≥ –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è** | –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—é VLF |
| **–†–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ –±—ã—Å—Ç—Ä–æ–º –¥–∏—Å–∫–µ** | –£—Å–∫–æ—Ä—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ |
| **–û—Ç–¥–µ–ª—å–Ω—ã–π –¥–∏—Å–∫ –¥–ª—è –∂—É—Ä–Ω–∞–ª–∞** | –£–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—é –∑–∞ I/O |
| **–†–µ–≥—É–ª—è—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ VLF** | –í—ã—è–≤–∏—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—é |
| **–¢–µ—Å—Ç–æ–≤–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** | –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±—ç–∫–∞–ø—ã —Ä–∞–±–æ—Ç–∞—é—Ç |
| **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫** | –ó–Ω–∞—Ç—å, —á—Ç–æ –≥–¥–µ –∏ –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ |

---

## 8. ‚úÖ –†–µ–∑—é–º–µ

- –ñ—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ‚Äî –∫–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä, —Ä–∞–∑–±–∏—Ç—ã–π –Ω–∞ VLF
- –£—Å–µ—á–µ–Ω–∏–µ ‚Äî –ª–æ–≥–∏—á–µ—Å–∫–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º–µ—Å—Ç–∞, –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç —Ñ–∞–π–ª
- –í SIMPLE —É—Å–µ—á–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ CHECKPOINT
- –í FULL —É—Å–µ—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ BACKUP LOG
- –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã —Ä–æ—Å—Ç–∞: –Ω–µ—Ç –±—ç–∫–∞–ø–æ–≤ –ª–æ–≥–∞, –¥–ª–∏–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è
- SHRINKFILE ‚Äî –∫—Ä–∞–π–Ω—è—è –º–µ—Ä–∞, –≤—ã–∑—ã–≤–∞–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—é
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ log_reuse_wait_desc –ø–æ–º–æ–≥–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

üîë **–ó–æ–ª–æ—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ:**  
> *¬´–ñ—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ‚Äî –∫–∞–∫ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ –µ—ë –Ω–µ —á–∏—Å—Ç–∏—Ç—å (–Ω–µ –¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø—ã –ª–æ–≥–∞), –æ–Ω–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏ –≤—Å—ë –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–µ–π —Ä–µ–≥—É–ª—è—Ä–Ω–æ!¬ª*

---

## 9. ‚ùì –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏

1. –ß—Ç–æ —Ç–∞–∫–æ–µ VLF –∏ –ø–æ—á–µ–º—É –∏—Ö –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ?
2. –ß–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è —É—Å–µ—á–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ –æ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ñ–∞–π–ª–∞?
3. –ü–æ—á–µ–º—É –≤ –º–æ–¥–µ–ª–∏ FULL –∂—É—Ä–Ω–∞–ª —Ä–∞—Å—Ç—ë—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ –¥–µ–ª–∞—Ç—å CHECKPOINT?
4. –ö–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç —É—Å–µ—á–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞?
5. –ö–∞–∫ —É–∑–Ω–∞—Ç—å, –ø–æ—á–µ–º—É –∂—É—Ä–Ω–∞–ª –Ω–µ —É—Å–µ–∫–∞–µ—Ç—Å—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±–∞–∑—ã?
6. –ß—Ç–æ —Ç–∞–∫–æ–µ –æ—à–∏–±–∫–∞ 9002 –∏ –∫–∞–∫ –µ—ë –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å?
7. –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å —Ñ–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞ –±–µ–∑ –≤—Ä–µ–¥–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏?
8. –ü–æ—á–µ–º—É –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ –∞–≤—Ç–æ—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è –∂—É—Ä–Ω–∞–ª–∞?
9. –ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–µ—Å—Å–∏—é, –∫–æ—Ç–æ—Ä–∞—è –¥–µ—Ä–∂–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç —É—Å–µ—á–µ–Ω–∏–µ?
10. –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç —Å –∂—É—Ä–Ω–∞–ª–æ–º, –µ—Å–ª–∏ –≤ FULL –º–æ–¥–µ–ª–∏ –¥–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –Ω–∞ 100%?
11. –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –∂—É—Ä–Ω–∞–ª–∞ –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 80%?
12. –í —á—ë–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –∞–∫—Ç–∏–≤–Ω–æ–π –∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π —á–∞—Å—Ç—å—é –∂—É—Ä–Ω–∞–ª–∞?
13. –ö–∞–∫ –≤–ª–∏—è–µ—Ç —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞ —É—Å–µ—á–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞?
14. –ü–æ—á–µ–º—É –ø–æ—Å–ª–µ SHRINKFILE –∂—É—Ä–Ω–∞–ª –º–æ–∂–µ—Ç —Å–Ω–æ–≤–∞ –±—ã—Å—Ç—Ä–æ –≤—ã—Ä–∞—Å—Ç–∏?
15. –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—é VLF –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –µ—ë?

---

## üìé –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ü–æ–ª–µ–∑–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

### –ü–æ–ª–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∂—É—Ä–Ω–∞–ª–∞

```sql
-- –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∂—É—Ä–Ω–∞–ª–∞ –¥–ª—è –≤—Å–µ—Ö –±–∞–∑
DECLARE @dbName NVARCHAR(128);
DECLARE db_cursor CURSOR FOR
    SELECT name FROM sys.databases 
    WHERE database_id > 4 AND state_desc = 'ONLINE';

CREATE TABLE #Results (
    DatabaseName NVARCHAR(128),
    LogSizeMB DECIMAL(18,2),
    LogUsedPercent DECIMAL(18,2),
    ReuseWait NVARCHAR(60),
    RecoveryModel NVARCHAR(60),
    VLFCount INT
);

OPEN db_cursor;
FETCH NEXT FROM db_cursor INTO @dbName;

WHILE @@FETCH_STATUS = 0
BEGIN
    INSERT INTO #Results (DatabaseName, LogSizeMB, LogUsedPercent, ReuseWait, RecoveryModel)
    EXEC ('
        SELECT 
            DB_NAME(),
            size * 8 / 1024.0,
            (SELECT CAST(lsu.LogSpaceUsedPercent AS DECIMAL(18,2))
             FROM sys.databases d
             CROSS APPLY sys.dm_db_log_space_usage lsu
             WHERE d.name = DB_NAME()),
            log_reuse_wait_desc,
            recovery_model_desc
        FROM sys.database_files
        WHERE type_desc = ''LOG''
    ');
    
    -- –ü–æ–¥—Å—á—ë—Ç VLF (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
    UPDATE #Results 
    SET VLFCount = (
        SELECT COUNT(*) 
        FROM sys.dm_db_log_info(DB_ID(@dbName))
    )
    WHERE DatabaseName = @dbName;
    
    FETCH NEXT FROM db_cursor INTO @dbName;
END

CLOSE db_cursor;
DEALLOCATE db_cursor;

SELECT * FROM #Results ORDER BY LogUsedPercent DESC;
DROP TABLE #Results;
```

### –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω–æ–π –±–∞–∑—ã

```sql
-- –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –∏–º—è –ø—Ä–æ–±–ª–µ–º–Ω–æ–π –±–∞–∑—ã
DECLARE @DB sysname = 'AdventureWorks';

SELECT 
    '–†–∞–∑–º–µ—Ä –∂—É—Ä–Ω–∞–ª–∞ (–ú–ë)' AS Metric,
    CAST(size * 8 / 1024.0 AS VARCHAR) AS Value
FROM sys.master_files
WHERE database_id = DB_ID(@DB) AND type_desc = 'LOG'
UNION ALL
SELECT 
    '–ó–∞–Ω—è—Ç–æ –º–µ—Å—Ç–∞ (%)',
    CAST(lsu.log_space_used_percent AS VARCHAR)
FROM sys.dm_db_log_space_usage lsu
CROSS JOIN sys.databases d
WHERE d.name = @DB
UNION ALL
SELECT 
    '–ü—Ä–∏—á–∏–Ω–∞ –æ–∂–∏–¥–∞–Ω–∏—è —É—Å–µ—á–µ–Ω–∏—è',
    log_reuse_wait_desc
FROM sys.databases
WHERE name = @DB
UNION ALL
SELECT 
    '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ VLF',
    CAST(COUNT(*) AS VARCHAR)
FROM sys.dm_db_log_info(DB_ID(@DB))
UNION ALL
SELECT 
    '–ê–∫—Ç–∏–≤–Ω—ã—Ö VLF',
    CAST(SUM(CASE WHEN vlf_active = 1 THEN 1 ELSE 0 END) AS VARCHAR)
FROM sys.dm_db_log_info(DB_ID(@DB));
```

---

üìú **–õ–∏—Ü–µ–Ω–∑–∏—è:** CC BY-NC-SA 4.0  
üë®‚Äçüè´ **–ê–≤—Ç–æ—Ä:** –†—É—Å–ª–∞–Ω –†–∏–Ω–∞—Ç–æ–≤–∏—á –°–∞—Ñ–∏—É–ª–∏–Ω  
üìÖ **–î–∞—Ç–∞:** 26.02.2026

# üîô üìö üîú –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫—É—Ä—Å—É

| [–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ](../LESSONS/PR16.MD) | &nbsp; | [–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ](../LESSONS/PR17.MD) |
|:--------------------------------------:|:------:|:-------------------------------------:|
| üè† [–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Ññ16](../LESSONS/PR16.MD) | üìñ [–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ](../README.MD) | üíª [–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Ññ17](../LESSONS/PR17.MD) |

