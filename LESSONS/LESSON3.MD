Предыдущее занятие | &nbsp; | Следующее занятие
:----------------:|:----------:|:----------------:
[ПР 1](PR1.MD) | [Содержание](../README.MD) | [ПР 2](PR2.MD)

### **Лекция 3: Архитектура MS SQL Server. Управление экземпляром и базами данных**

**Цель:** Изучить основы архитектуры MS SQL Server, принципы управления экземпляром сервера и структуру базы данных. Научиться получать системную информацию о базах данных и их файлах.

---

### **3.1. Запуск и останов экземпляра сервера**

Экземпляр SQL Server — это отдельная копия серверного исполняемого файла (sqlservr.exe), которая работает как системная служба Windows. Каждый экземпляр имеет свои настройки, базы данных, порты для подключения и может работать независимо от других.

#### **3.1.1. Запуск экземпляра сервера**

Существует несколько способов запуска экземпляра SQL Server:

**1. Через Службы Windows (Services.msc)**
*   Это основной и наиболее надежный способ.
*   Откройте «Службы» (Win + R -> `services.msc`).
*   Найдите службу с именем:
    *   `SQL Server (MSSQLSERVER)` — для экземпляра по умолчанию.
    *   `SQL Server (ИМЯ_ЭКЗЕМПЛЯРА)` — для именованного экземпляра (например, `SQL Server (SQLEXPRESS)`).
*   Щелкните правой кнопкой мыши и выберите **«Запустить»**.

**2. Через Диспетчер конфигурации SQL Server (SQL Server Configuration Manager)**
*   Это предпочтительный инструмент администратора, так как он предоставляет больше информации и контроля.
*   Запустите «SQL Server Configuration Manager».
*   Перейдите в «Службы SQL Server».
*   Выберите нужную службу и используйте кнопки на панели инструментов или контекстное меню для ее запуска.
*   *Преимущество:* здесь же можно настроить параметры запуска, учетные записи служб и протоколы.

**3. Из командной строки**
*   Запуск из командной строки с правами администратора:
    ```cmd
    net start "SQL Server (MSSQLSERVER)"
    ```
    или для именованного экземпляра:
    ```cmd
    net start "SQL Server (SQLEXPRESS)"
    ```

**4. Автоматический запуск**
*   Чтобы экземпляр запускался автоматически при загрузке ОС, в «Службах» или «Диспетчере конфигурации» установите для службы «Тип запуска» в значение **«Автоматически»**.

#### **3.1.2. Останов экземпляра сервера**

Остановка сервера требует осторожности, так как все подключенные пользователи будут отключены, а незавершенные транзакции откатятся.

**1. Через Службы Windows (Services.msc)**
*   Аналогично запуску: найдите службу и выберите **«Остановить»**.

**2. Через Диспетчер конфигурации SQL Server**
*   Выберите службу и нажмите «Остановить».

**3. Через SQL Server Management Studio (SSMS)**
*   В обозревателе объектов щелкните правой кнопкой мыши по экземпляру сервера и выберите **«Остановить»**.
*   Система запросит подтверждение, так как это действие приведет к отключению всех пользователей.

**4. Из командной строки**
*   Останов из командной строки с правами администратора:
    ```cmd
    net stop "SQL Server (MSSQLSERVER)"
    ```

**Режимы остановки:**
*   **Немедленная остановка (`SHUTDOWN`):** Выполняет контрольную точку для всех БД и останавливает сервер. Незавершенные транзакции откатываются.
*   **Остановка с ожиданием (`SHUTDOWN WITH NOWAIT`):** Немедленная остановка без контрольных точек. Может привести к длительному восстановлению при следующем запуске. **Не рекомендуется.**

---

### **3.2. Что собой представляет база данных в SQL Server**

#### **1. Общая информация и хранение метаданных**

*   Все сведения о базах данных текущего экземпляра SQL Server хранятся в **системной базе данных `master`**.
*   Просматривать эту информацию могут пользователи с соответствующими правами доступа (полномочиями).
*   В `master` хранится информация о самих БД и о всех файлах, входящих в их состав.

#### **2. Два вида баз данных**


База данных в SQL Server — это не просто "папка с таблицами", а сложный контейнер, состоящий из двух типов файлов и группы файлов, которые управляются СУБД.

**Логическая структура:**
*   **Таблицы**
*   **Представления (Views)**
*   **Хранимые процедуры (Stored Procedures)**
*   **Индексы** и другие объекты.

В SQL Server существует два основных типа баз данных:

**A. Системные базы данных**
*   **Создание:** Создаются автоматически в процессе установки SQL Server.
*   **Управление:** Изменяются в основном автоматически системой. Пользовательские изменения допустимы, но требуют глубокого понимания последствий.
*   **Пример использования:** Администраторы и разработчики часто настраивают базу `model`, которая служит шаблоном для создания новых пользовательских БД.

**B. Пользовательские базы данных**
*   **Создание и управление:** Создаются, изменяются и удаляются пользователем (администратором, разработчиком).
*   **Назначение:** Используются для хранения данных и объектов конкретной предметной области (например, данные приложения, сайта, предприятия).
*   **Содержимое:**
    *   Пользовательские данные (таблицы).
    *   Объекты БД: хранимые процедуры, функции, триггеры, пользовательские типы данных.

#### **3. Физическая структура базы данных**

Любая БД в SQL Server состоит как минимум из двух типов файлов:

*   **Файлы данных (.mdf, .ndf):**
    *   Хранят сами данные и объекты БД (таблицы, индексы и т.д.).
    *   Могут объединяться в **файловые группы** для удобства управления и повышения производительности.

*   **Файлы журнала транзакций (.ldf):**
    *   Хранят журнал всех изменений данных.
    *   Обеспечивают целостность данных и возможность восстановления.
    *   **Не входят в файловые группы.**

**Именование файлов:**
*   **Логическое имя:** Имя, используемое для обращения к файлу внутри SQL Server (в командах T-SQL).
*   **Физическое имя:** Фактическое имя файла и путь к нему в операционной системе.

#### **4. Логические атрибуты и идентификация базы данных**

*   **Логическое имя:** Уникальное имя, задаваемое при создании БД. Используется для большинства операций.
*   **Идентификатор (ID):** Уникальный числовой код, который присваивается базе данных автоматически при ее создании.
*   **Функции для преобразования:**
    *   **`DB_ID('Имя_БД')`** — возвращает идентификатор базы данных по ее имени.
    *   **`DB_NAME(ИД_БД)`** — возвращает имя базы данных по ее идентификатор.


**Ключевые выводы:**
1.  SQL Server различает **системные** (служебные) и **пользовательские** (для данных) базы данных.
2.  Физически БД — это набор **файлов данных** и **файлов журнала**.
3.  Управление БД осуществляется по ее **логическому имени**, а системой для внутренних операций используется **уникальный идентификатор (ID)**.


#### **3.2.1. Системные базы данных**

Это базы данных, которые создаются автоматически при установке SQL Server и необходимы для его функционирования.

1.  **master**
    *   **Назначение:** Главная база данных. Хранит всю системную информацию уровня экземпляра:
        *   Имена всех других баз данных.
        *   Расположение их файлов.
        *   Имена входов (логинов).
        *   Настройки сервера.
    *   **Важность:** **Крайне важна.** Повреждение базы данных `master` может сделать весь экземпляр сервера неработоспособным. Обязательно регулярное резервное копирование.

2.  **model**
    *   **Назначение:** Шаблон для создания всех новых пользовательских баз данных.
    *   **Применение:** Когда вы выполняете `CREATE DATABASE`, SQL Server копирует содержимое базы данных `model` в новую БД. Если вам нужно, чтобы во всех новых БД была определенная таблица или настройка, можно добавить ее в `model`.

3.  **msdb**
    *   **Назначение:** Используется агентом SQL Server (SQL Server Agent) для планирования заданий и оповещений, а также для служб уведомлений, резервного копирования и восстановления.
    *   **Содержимое:** История заданий, расписания, настройки операторов, история бэкапов.

4.  **tempdb**
    *   **Назначение:** Временное рабочее пространство для сервера.
    *   **Содержимое:** Временные таблицы (`#table`), табличные переменные, промежуточные результаты сортировки, версии строк и др.
    *   **Особенности:**
        *   Пересоздается заново при каждом запуске SQL Server.
        *   Не подлежит резервному копированию.
        *   Может быть "бутылочным горлышком" производительности, поэтому требует правильной настройки.

5.  **Resource (скрытая)**
    *   **Назначение:** Доступная только для чтения база данных, которая содержит все системные объекты (например, системные представления `sys.*`).
    *   **Физически** файлы `mssqlsystemresource.mdf/ldf` находятся в папке `Binn`.
    *   **Логически** она не видна в списке баз данных, но ее объекты отображаются в каждой БД через схему `sys`.

#### **3.2.2. Базы данных пользователей**

*   Это базы данных, созданные администраторами, разработчиками или пользователями для хранения пользовательских данных и объектов.
*   Примеры: `University`, `AdventureWorks`, `MyAppDatabase`.
*   Они наследуют настройки от базы данных `model` в момент создания.

#### **3.2.3. Некоторые характеристики базы данных**

##### **3.2.3.1. Владелец базы данных (Owner)**

Владелец БД (owner) имеет все полномочия к базе данных. Он может изменять характеристики базы, удалять ее, вносить любые изменения в данные и метаданные.
Владельцем БД становится пользователь, создавший базу данных.

Владельца пользовательской базы данных можно изменить, используя в языке
Transact-SQL системную процедуру `sp_changedbowner`. Вот несколько упрощенный
синтаксис обращения к этой процедуре:

`EXECUTE sp_changedbowner '<имя нового владельца>'`

Функция возвращает значение 0 при успешной смене владельца или 1 в случае возникновения ошибки. Например, для изменения владельца текущей БД можно выполнить следующее обращение к этой процедуре:

`EXECUTE sp_changedbowner 'anotherowner'`

Имя нового владельца уже должно быть описано в системе. Чтобы получить список
существующих в системе пользователей, можно выполнить системную хранимую
процедуру `sp_helplogins`:

`EXEC sp_helplogins;` 

##### **3.2.3.2. Порядок сортировки (Collation)**
Порядок сортировки (collation) для базы данных определяет допустимый набор
символов в строковых типах данных `CHAR`, `VARCHAR` и правила, по которым будут при
необходимости упорядочиваться эти строковые данные. Порядок сортировки определяет, будет ли сортировка происходить по внутреннему коду или в лексикографическом (алфавитном) порядке, в каком порядке будут размещаться строчные и
прописные буквы, как распределяются знаки препинания, иные специальные символы и др. Если для строкового типа данных явно не указан порядок сортировки, то
ему будет присвоен порядок, заданный по умолчанию для всей БД. Для элемента
данных при его описании в базе можно указать любой допустимый порядок сортировки, отличный от порядка сортировки базы данных.

##### 3.2.3.3. Возможность изменения данных базы данных
База данных может находиться в состоянии только для чтения (READ_ONLY) или быть
доступной как для чтения, так и для внесения изменений в данные (READ_WRITE). 

##### 3.2.3.4.   **Состояние базы данных:**
    *   **ONLINE:** База данных доступна для работы.
    *   **OFFLINE:** База данных недоступна. Ее файлы можно перемещать.
    *   **RESTORING:** Выполняется восстановление базы данных.
    *   **RECOVERING:** Сервер находится в процессе восстановления базы данных (откат/повтор транзакций).
    *   **SUSPECT:** База данных повреждена и не может быть восстановлена при запуске. Требует вмешательства администратора.
*   **Уровень совместимости (Compatibility Level):** Определяет, с какой версией SQL Server совместимо поведение ядра СУБД для данной БД. Может быть ниже версии самого сервера.
*   **Параметры восстановления (Recovery Model):**
    *   **Simple:** Журнал транзакций усекается при каждой контрольной точке. Не позволяет восстанавливаться на момент времени.
    *   **Full:** Все операции полностью журналируются. Позволяет восстановить базу данных на любой момент времени.
    *   **Bulk-Logged:** Комбинация Full и Simple, минимально журналирует некоторые массовые операции.

#### **3.2.4. Некоторые характеристики файлов базы данных**

*   **Файлы данных:**
    *   **Primary Data File (.mdf):** Главный файл, с которого начинается база данных. Содержит системные таблицы и может содержать пользовательские данные. Каждая БД имеет ровно один `.mdf`-файл.
    *   **Secondary Data File (.ndf):** Дополнительные файлы данных. Используются для распределения данных по разным дискам (для повышения производительности) или для облегчения управления.
*   **Файл журнала транзакций (.ldf):** Хранит всю историю изменений. Каждая БД имеет хотя бы один `.ldf`-файл.
*   **Группы файлов (Filegroups):** Логическая структура, объединяющая файлы данных.
    *   **PRIMARY:** Группа, содержащая первичный файл (.mdf). Все системные таблицы находятся в этой группе.
    *   **USER_DEFINED:** Группы, созданные пользователем. Позволяют явно размещать таблицы и индексы в конкретных файловых группах.

---

### **3.3. Получение сведений о базах данных и их файлах в текущем экземпляре сервера**

Для получения метаинформации о базах данных и файлах SQL Server предоставляет системные представления (System Views).

#### **3.3.1. Системное представление sys.databases**

Содержит по одной строке для каждой базы данных на экземпляре SQL Server.

```sql
SELECT 
    name AS 'Database Name',
    database_id AS 'DB ID',
    state_desc AS 'State',
    recovery_model_desc AS 'Recovery Model',
    compatibility_level AS 'Compatibility Level',
    create_date AS 'Create Date'
FROM sys.databases;
```

**Ключевые столбцы:**
*   `name` — имя базы данных.
*   `database_id` — уникальный идентификатор БД внутри экземпляра.
*   `state_desc` — состояние БД (ONLINE, OFFLINE, etc.).
*   `recovery_model_desc` — модель восстановления.
*   `compatibility_level` — уровень совместимости.

#### **3.3.2. Системное представление sys.master_files**

Содержит по одной строке для каждого файла каждой базы данных экземпляра. Это "централизованное" представление.

```sql
SELECT 
    DB_NAME(database_id) AS 'Database Name',
    name AS 'Logical File Name',
    type_desc AS 'File Type',
    physical_name AS 'Physical File Path',
    size * 8 / 1024 AS 'Size (MB)', -- Размер в страницах (1 стр = 8 КБ)
    max_size AS 'Max Size'
FROM sys.master_files;
```

**Ключевые столбцы:**
*   `database_id` — идентификатор БД, к которой принадлежит файл.
*   `name` — логическое имя файла.
*   `type` — 0 = данные (ROWS), 1 = журнал (LOG).
*   `physical_name` — полный путь к физическому файлу на диске.
*   `size` — текущий размер файла в страницах (1 страница = 8 КБ).

#### **3.3.3. Системное представление sys.database_files**

Содержит информацию о файлах **текущей** базы данных. Это представление нужно выполнять в контексте конкретной БД.

```sql
USE University; -- Переключаемся на базу University
SELECT 
    name AS 'Logical File Name',
    type_desc AS 'File Type',
    physical_name AS 'Physical File Path',
    size * 8 / 1024 AS 'Size (MB)',
    max_size AS 'Max Size'
FROM sys.database_files;
```

**Отличие от `sys.master_files`:**
*   `sys.master_files` показывает файлы всех БД с одного запроса.
*   `sys.database_files` показывает файлы только той БД, в которой выполняется запрос.

#### **3.3.4. Системное представление sys.filegroups**

Содержит информацию о файловых группах **текущей** базы данных.

```sql
USE University;
SELECT 
    name AS 'Filegroup Name',
    type_desc AS 'Type',
    is_default AS 'Is Default'
FROM sys.filegroups;
```

#### **3.3.5. Другие средства получения сведений об объектах базы данных**

1.  **Встроенные отчеты SSMS:**
    *   В обозревателе объектов щелкните правой кнопкой мыши по базе данных.
    *   Выберите «Отчеты» -> «Стандартные отчеты».
    *   Полезные отчеты: «Использование дискового пространства», «Сведения о транзакциях».

2.  **Функция `DATABASEPROPERTYEX()`:**
    *   Позволяет получить значение конкретного свойства базы данных.
    ```sql
    SELECT DATABASEPROPERTYEX('University', 'RecoveryModel');
    ```

3.  **Команда `sp_helpdb` (устаревшая, но полезная):**
    *   Выводит общую информацию о всех БД или об указанной.
    ```sql
    EXEC sp_helpdb 'University';
    ```



**Практическое задание для студентов:**
1.  Напишите запрос к `sys.databases`, чтобы найти все базы данных, находящиеся в состоянии ONLINE.
2.  С помощью `sys.master_files` определите, на каком диске расположены файлы данных и журналов для базы данных `master`.
3.  Переключитесь на вашу учебную базу данных и с помощью `sys.database_files` узнайте текущий размер ее файлов в мегабайтах.

**Вывод:** Управление экземпляром SQL Server и понимание физической и логической структуры баз данных являются фундаментальными навыками администратора. Знание системных представлений позволяет эффективно мониторить и администрировать среду SQL Server.

---
**Лицензия:** [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/)  
**Автор:** Руслан Ринатович Сафиулин  
**Дата:** 08.09.2025

---

Предыдущее занятие | &nbsp; | Следующее занятие
:----------------:|:----------:|:----------------:
[ПР 1](PR1.MD) | [Содержание](../README.MD) | [ПР 2](PR2.MD)
