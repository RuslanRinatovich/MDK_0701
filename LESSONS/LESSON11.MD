### üîô üìö üîú –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫—É—Ä—Å—É

| [–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ](../LESSONS/PR9.MD) | &nbsp; | [–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ](../LESSONS/PR10.MD) |
|:--------------------------------------:|:------:|:-------------------------------------:|
| üè† [–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Ññ9](../LESSONS/PR9.MD) | üìñ [–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ](../README.MD) | üíª [–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Ññ10](../LESSONS/PR10.MD) |

# üéì **–õ–µ–∫—Ü–∏—è 10. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (DMV): —Å–µ—Å—Å–∏–∏, –æ–∂–∏–¥–∞–Ω–∏—è, —Ä–µ—Å—É—Ä—Å—ã**
‚è±Ô∏è **–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 90 –º–∏–Ω—É—Ç

üéØ **–¶–µ–ª—å –ª–µ–∫—Ü–∏–∏:**
–ü–æ–∫–∞–∑–∞—Ç—å DMV –∫–∞–∫ ¬´–¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫–∞–Ω–µ—Ä¬ª —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞. –ù–∞—É—á–∏—Ç—å ¬´—á–∏—Ç–∞—Ç—å¬ª —Å–∏–º–ø—Ç–æ–º—ã –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ —Å–µ—Å—Å–∏–π, –æ–∂–∏–¥–∞–Ω–∏–π –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤. –î–∞—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä ¬´—Ç–æ—Ä–º–æ–∑–∏—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å¬ª.

## **üìñ –ß–∞—Å—Ç—å 0. –ì–ª–∞–≤–Ω–æ–µ ‚Äî –∑–∞–ø–æ–º–Ω–∏—Ç–µ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞**

> **üí° –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (DMV) ‚Äî —ç—Ç–æ ¬´–ø—Ä–∏–±–æ—Ä–Ω–∞—è –ø–∞–Ω–µ–ª—å¬ª —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ SQL Server.**
>
> –ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (`sys.`) ‚Äî —ç—Ç–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ **—Å—Ç—Ä—É–∫—Ç—É—Ä–µ** –ë–î (¬´—á—Ç–æ –µ—Å—Ç—å¬ª), —Ç–æ DMV (`sys.dm_`) ‚Äî —ç—Ç–æ —Å–Ω–∏–º–æ–∫ **—Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è** —Å–µ—Ä–≤–µ—Ä–∞ (¬´—á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å¬ª).
>
> **DMV –Ω–µ —Ö—Ä–∞–Ω—è—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ –¥–∏—Å–∫–µ.** –û–Ω–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è ¬´–Ω–∞ –ª–µ—Ç—É¬ª –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ—ç—Ç–æ–º—É –∏—Ö –¥–∞–Ω–Ω—ã–µ –æ–±–Ω—É–ª—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–∞.

## **1. –ß—Ç–æ —Ç–∞–∫–æ–µ DMV? –ñ–∏–≤–∞—è –∞–Ω–∞—Ç–æ–º–∏—è SQL Server**

**üîπ –§–æ—Ä–º–∞–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:**
–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Dynamic Management Views) ‚Äî —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–µ —Å–µ—Ä–≤–µ—Ä–Ω—É—é state information –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ SQL Server.

**üîπ –ü—Ä–æ—Å—Ç–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:**
–≠—Ç–æ ¬´–æ–∫–Ω–æ¬ª –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–º—è—Ç—å SQL Server, –≥–¥–µ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å:
*   **–ö—Ç–æ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è** –∫ —Å–µ—Ä–≤–µ—Ä—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?
*   **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç** –∫–∞–∂–¥—ã–π –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?
*   **–ß–µ–≥–æ –æ–Ω –∂–¥—ë—Ç** (–ø–æ—á–µ–º—É —Ç–æ—Ä–º–æ–∑–∏—Ç)?
*   **–ö–∞–∫—É—é –ø–∞–º—è—Ç—å/CPU** —Å—ä–µ–¥–∞–µ—Ç –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å?

**‚úÖ –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è DMV –æ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π:**

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (`sys.`) | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (`sys.dm_`) |
| :--- | :--- | :--- |
| **–î–∞–Ω–Ω—ã–µ** | –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞) | State information (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ) |
| **–•—Ä–∞–Ω–µ–Ω–∏–µ** | –ù–∞ –¥–∏—Å–∫–µ, –≤ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ë–î | –í –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ |
| **–°–±—Ä–æ—Å** | –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è | –°–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ |
| **–ü—Ä–∏–º–µ—Ä** | `sys.tables` | `sys.dm_exec_sessions` |

## **2. –ì–ª–∞–≤–Ω—ã–µ DMV –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ ¬´–∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å¬ª (–¢–û–ü-8)**

**üñ•Ô∏è 1. `sys.dm_exec_sessions` ‚Äî –∫—Ç–æ –ø–æ–¥–∫–ª—é—á–µ–Ω?**
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–µ—Å—Å–∏–∏.

```sql
SELECT 
    session_id AS SPID,
    login_name AS LoginName,
    host_name AS HostName,
    program_name AS ProgramName,
    status AS Status
FROM sys.dm_exec_sessions
WHERE is_user_process = 1; -- –¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–µ—Å—Å–∏–∏
```

**üí° –ß—Ç–æ –∏—Å–∫–∞—Ç—å:**
*   `status` = 'running' ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å, 'sleeping' ‚Äî –∂–¥—ë—Ç –Ω–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã.
*   –ù–µ–∑–Ω–∞–∫–æ–º—ã–µ `program_name` –∏–ª–∏ `host_name` ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.

**üñ•Ô∏è 2. `sys.dm_exec_requests` ‚Äî —á—Ç–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏?**
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω—è—é—â–∏–µ—Å—è –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å—ã.

```sql
SELECT 
    session_id AS SPID,
    command AS CommandType,
    status AS RequestStatus,
    cpu_time AS CPUMs,
    total_elapsed_time AS DurationMs,
    reads AS LogicalReads,
    writes AS Writes
FROM sys.dm_exec_requests
WHERE session_id > 50; -- –ò—Å–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–µ—Å—Å–∏–∏
```

**üí° –ß—Ç–æ –∏—Å–∫–∞—Ç—å:**
*   –ë–æ–ª—å—à–æ–µ `total_elapsed_time` ‚Äî ¬´–≤–∏—Å—è—á–∏–π¬ª –∑–∞–ø—Ä–æ—Å.
*   –ë–æ–ª—å—à–∏–µ `reads` ‚Äî –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –º–Ω–æ–≥–æ —á–∏—Ç–∞–µ—Ç.

**üñ•Ô∏è 3. `sys.dm_exec_sql_text` ‚Äî —á—Ç–æ –∑–∞ –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è?**
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç SQL-–∑–∞–ø—Ä–æ—Å–∞ –ø–æ –µ–≥–æ `sql_handle`.

**üí° –ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å:** DMV —á–∞—Å—Ç–æ –Ω—É–∂–Ω–æ **—Å–æ–µ–¥–∏–Ω—è—Ç—å**. `sys.dm_exec_requests` –∑–Ω–∞–µ—Ç, –ö–ê–ö–û–ô –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –Ω–æ –Ω–µ –∑–Ω–∞–µ—Ç –µ–≥–æ –¢–ï–ö–°–¢. –¢–µ–∫—Å—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `sys.dm_exec_sql_text`.

```sql
-- –°–æ–µ–¥–∏–Ω—è–µ–º requests –∏ sql_text
SELECT 
    r.session_id,
    r.status,
    r.command,
    t.text AS QueryText
FROM sys.dm_exec_requests r
CROSS APPLY sys.dm_exec_sql_text(r.sql_handle) t;
```

**üñ•Ô∏è 4. `sys.dm_os_wait_stats` ‚Äî –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–∂–∏–¥–∞–Ω–∏–π**
–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º —Ç–∏–ø–∞–º –æ–∂–∏–¥–∞–Ω–∏–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±—Ä–æ—Å–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞.

```sql
SELECT 
    wait_type AS WaitType,
    waiting_tasks_count AS WaitCount,
    wait_time_ms AS TotalWaitTimeMs,
    signal_wait_time_ms AS SignalWaitTimeMs
FROM sys.dm_os_wait_stats
ORDER BY wait_time_ms DESC;
```

**üí° –ß—Ç–æ –∏—Å–∫–∞—Ç—å (–¢–û–ü-3 –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –æ–∂–∏–¥–∞–Ω–∏—è):**
*   **`CXPACKET`** ‚Äî –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —á–∞—Å—Ç–æ –∏–∑-–∑–∞ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞.
*   **`PAGEIOLATCH_*`** ‚Äî –æ–∂–∏–¥–∞–Ω–∏–µ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –¥–∏—Å–∫–∞ (–º–µ–¥–ª–µ–Ω–Ω—ã–π –¥–∏—Å–∫/–ø–∞–º—è—Ç—å).
*   **`LCK_*`** ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–¥–æ–ª–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏).

**üñ•Ô∏è 5. `sys.dm_os_waiting_tasks` ‚Äî –∫—Ç–æ —á–µ–≥–æ –∂–¥–µ—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?**
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ–∂–∏–¥–∞—é—Ç —Ä–µ—Å—É—Ä—Å.

```sql
SELECT 
    session_id AS SPID,
    wait_type AS WaitType,
    wait_duration_ms AS WaitDurationMs,
    resource_description AS Resource
FROM sys.dm_os_waiting_tasks
WHERE session_id > 50;
```

**üñ•Ô∏è 6. `sys.dm_db_index_usage_stats` ‚Äî –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏–Ω–¥–µ–∫—Å—ã?**
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∫–∞–∂–¥—ã–π –∏–Ω–¥–µ–∫—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∏—Å–∫–∞/—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

```sql
SELECT 
    OBJECT_NAME(s.object_id) AS TableName,
    i.name AS IndexName,
    s.user_seeks,
    s.user_scans,
    s.user_lookups,
    s.user_updates
FROM sys.dm_db_index_usage_stats s
INNER JOIN sys.indexes i ON s.object_id = i.object_id AND s.index_id = i.index_id
WHERE s.database_id = DB_ID('AdminDiagLab');
```

**üí° –ß—Ç–æ –∏—Å–∫–∞—Ç—å:**
*   –ò–Ω–¥–µ–∫—Å—ã —Å `user_seeks=0` –∏ `user_scans=0`, –Ω–æ `user_updates>0` ‚Äî –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–ª—å–∫–æ –∑–∞–º–µ–¥–ª—è—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.
*   –ë–æ–ª—å—à–æ–µ `user_lookups` ‚Äî –Ω–µ—Ö–≤–∞—Ç–∫–∞ –ø–æ–∫—Ä—ã–≤–∞—é—â–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤.

**üñ•Ô∏è 7. `sys.dm_io_virtual_file_stats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞ –ø–æ —Ñ–∞–π–ª–∞–º –ë–î**
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –ë–î (mdf, ldf) –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –Ω–∞–≥—Ä—É–∂–∞—é—Ç –¥–∏—Å–∫.

```sql
SELECT 
    DB_NAME(database_id) AS DatabaseName,
    name AS LogicalFileName,
    io_stall_read_ms AS ReadStallMs,
    io_stall_write_ms AS WriteStallMs
FROM sys.dm_io_virtual_file_stats(NULL, NULL);
```

**üñ•Ô∏è 8. `sys.dm_exec_query_stats` ‚Äî –∫—ç—à –ø–ª–∞–Ω–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º, –ø–ª–∞–Ω—ã –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –≤ –∫—ç—à–µ.

```sql
SELECT TOP 10
    t.text AS QueryText,
    s.execution_count AS ExecutionCount,
    s.total_worker_time / s.execution_count AS AvgCPUMs,
    s.total_logical_reads / s.execution_count AS AvgLogicalReads
FROM sys.dm_exec_query_stats s
CROSS APPLY sys.dm_exec_sql_text(s.sql_handle) t
ORDER BY s.total_worker_time DESC;
```

## **3. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**

**üéØ –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–µ—Ä–≤–µ—Ä ¬´—Ç–æ—Ä–º–æ–∑–∏—Ç¬ª. –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞ 60 —Å–µ–∫—É–Ω–¥.**

```sql
-- –®–∞–≥ 1: –ö—Ç–æ —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–µ–Ω –∏ —á—Ç–æ –¥–µ–ª–∞–µ—Ç?
SELECT 
    s.session_id,
    s.login_name,
    s.host_name,
    r.status,
    r.command,
    r.wait_type,
    r.wait_time,
    t.text AS QueryText
FROM sys.dm_exec_sessions s
LEFT JOIN sys.dm_exec_requests r ON s.session_id = r.session_id
OUTER APPLY sys.dm_exec_sql_text(r.sql_handle) t
WHERE s.is_user_process = 1
AND r.session_id IS NOT NULL; -- –¢–æ–ª—å–∫–æ —Ç–µ, –∫—Ç–æ —á—Ç–æ-—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç
```

**üéØ –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–∏—Å–∫ —Å–∞–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è (—Å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏).**

```sql
-- –¢–æ–ø-5 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—é CPU
SELECT TOP 5
    qs.total_worker_time / 1000 AS TotalCPUMs,
    qs.execution_count,
    (qs.total_worker_time / 1000) / qs.execution_count AS AvgCPUMs,
    SUBSTRING(qt.text, qs.statement_start_offset/2 + 1,
        (CASE WHEN qs.statement_end_offset = -1
              THEN LEN(CONVERT(nvarchar(max), qt.text)) * 2
              ELSE qs.statement_end_offset
         END - qs.statement_start_offset)/2 + 1) AS QueryText,
    qt.text AS FullQueryText
FROM sys.dm_exec_query_stats qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) qt
ORDER BY qs.total_worker_time DESC;
```

**üéØ –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–∏—Å–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (–∫—Ç–æ –∫–æ–≥–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç).**

```sql
-- –ù–∞—Ö–æ–¥–∏–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
SELECT 
    t1.resource_type AS ResourceType,
    t1.resource_database_id AS DatabaseID,
    t1.resource_associated_entity_id AS EntityID,
    t1.request_mode AS RequestMode,
    t1.request_session_id AS RequestSessionID,
    t2.blocking_session_id AS BlockingSessionID
FROM sys.dm_tran_locks t1
INNER JOIN sys.dm_os_waiting_tasks t2 ON t1.lock_owner_address = t2.resource_address;
```

## **4. –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ (—Å –æ—Ç–≤–µ—Ç–∞–º–∏)**

1.  **–ß–µ–º DMV –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç –æ–±—ã—á–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π?**
    ‚Üí DMV –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏, —Å–∏—Å—Ç–µ–º–Ω—ã–µ ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–∞ –¥–∏—Å–∫–µ.

2.  **–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ DMV –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ SQL Server?**
    ‚Üí –û–Ω–∏ –æ–±–Ω—É–ª—è—Ç—Å—è.

3.  **–ö–∞–∫ –Ω–∞–π—Ç–∏ —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Å–µ—Å—Å–∏–∏ 67?**
    ‚Üí `SELECT text FROM sys.dm_exec_sql_text((SELECT sql_handle FROM sys.dm_exec_requests WHERE session_id=67));`

4.  **–ö–∞–∫–æ–µ DMV –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ —Å–µ—Å—Å–∏—è –∂–¥—ë—Ç —Ä–µ—Å—É—Ä—Å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?**
    ‚Üí `sys.dm_os_waiting_tasks`.

5.  **–ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ–∂–∏–¥–∞–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ?**
    ‚Üí `sys.dm_os_wait_stats`, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ `wait_time_ms DESC`.

## **5. –ü–æ–¥–≤–µ–¥–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤ ‚Äî 5 –∫–ª—é—á–µ–≤—ã—Ö –º—ã—Å–ª–µ–π**

1.  **DMV ‚Äî –≤–∞—à –≥–ª–∞–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö ¬´—Å–µ—Ä–≤–µ—Ä —Ç–æ—Ä–º–æ–∑–∏—Ç¬ª.**
2.  **DMV –Ω—É–∂–Ω–æ —Å–æ–µ–¥–∏–Ω—è—Ç—å.** –û–¥–Ω–æ DMV —Ä–µ–¥–∫–æ –¥–∞—ë—Ç –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É.
3.  **`sys.dm_exec_sessions` + `sys.dm_exec_requests` + `sys.dm_exec_sql_text` = –æ—Å–Ω–æ–≤–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.**
4.  **–û–∂–∏–¥–∞–Ω–∏—è (`wait_stats`) ‚Äî –∫–ª—é—á –∫ –ø–æ–Ω–∏–º–∞–Ω–∏—é ¬´—É–∑–∫–∏—Ö –º–µ—Å—Ç¬ª.**
5.  **–î–∞–Ω–Ω—ã–µ DMV –≤—Ä–µ–º–µ–Ω–Ω—ã.** –î–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Å–±–æ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –ë–î.

**üîú –ß—Ç–æ –¥–∞–ª—å—à–µ?**
–í –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–±–æ—Ç–µ ‚Ññ10 –≤—ã:
*   –ù–∞—É—á–∏—Ç–µ—Å—å –Ω–∞—Ö–æ–¥–∏—Ç—å ¬´–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ¬ª —Å–µ—Å—Å–∏–∏.
*   –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ —Ç–µ–∫—É—â—É—é –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
*   –ù–∞–π–¥–µ—Ç–µ —Å–∞–º—ã–µ —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã.

---

üìú **–õ–∏—Ü–µ–Ω–∑–∏—è**: [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/)  
üë®‚Äçüè´ **–ê–≤—Ç–æ—Ä**: –†—É—Å–ª–∞–Ω –†–∏–Ω–∞—Ç–æ–≤–∏—á –°–∞—Ñ–∏—É–ª–∏–Ω  
üìÖ **–î–∞—Ç–∞**: 27.11.2025  

---

### üîô üìö üîú –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫—É—Ä—Å—É

| [–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ](../LESSONS/PR9.MD) | &nbsp; | [–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ](../LESSONS/PR10.MD) |
|:--------------------------------------:|:------:|:-------------------------------------:|
| üè† [–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Ññ9](../LESSONS/PR9.MD) | üìñ [–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ](../README.MD) | üíª [–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Ññ10](../LESSONS/PR10.MD) |
